<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ripple AI Assistant</title>
  <style>
    :root {
      --bg: #0f0f0f;
      --text: #ffffff;
      --user-bg: #4b6cb7;
      --bot-bg: #2e2e2e;
    }
    body.light {
      --bg: #ffffff;
      --text: #000000;
      --user-bg: #cce5ff;
      --bot-bg: #f1f1f1;
    }
    body.blue {
      --bg: #001f3f;
      --text: #ffffff;
      --user-bg: #0074d9;
      --bot-bg: #003366;
    }
    body.pink {
      --bg: #ffe6f0;
      --text: #4b004b;
      --user-bg: #ff99cc;
      --bot-bg: #ffe0f0;
    }
    body.cyber {
      --bg: #0f0f0f;
      --text: #00ffea;
      --user-bg: #00ffaa;
      --bot-bg: #003b3b;
    }
    * {
      box-sizing: border-box;
      font-family: 'Segoe UI', sans-serif;
    }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      height: 100vh;
      transition: background 0.3s, color 0.3s;
    }
    #themeToggle {
      position: absolute;
      top: 10px;
      left: 10px;
      background: none;
      color: var(--text);
      font-size: 16px;
      border: 1px solid var(--text);
      padding: 4px 8px;
      border-radius: 5px;
      cursor: pointer;
      z-index: 100;
    }
    #chat {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .message {
      padding: 14px 20px;
      border-radius: 20px;
      max-width: 80%;
      font-size: 1.05rem;
      line-height: 1.4;
      word-wrap: break-word;
      animation: bubbleIn 0.3s ease-out;
      position: relative;
    }
    .message small {
      display: block;
      font-size: 0.7rem;
      opacity: 0.7;
      margin-bottom: 5px;
    }
    .user { background: var(--user-bg); align-self: flex-end; }
    .bot { background: var(--bot-bg); align-self: flex-start; }

    @keyframes bubbleIn {
      0% { opacity: 0; transform: translateY(10px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    #inputArea {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px 10px;
      border-top: 1px solid #333;
    }
    .mic-button {
      background: radial-gradient(circle at center, #007aff, #003366);
      border: none;
      width: 70px;
      height: 70px;
      border-radius: 50%;
      font-size: 1.8rem;
      box-shadow: 0 0 25px rgba(0,122,255,0.6);
      color: white;
      cursor: pointer;
    }
    .mic-button:hover { transform: scale(1.05); }
    .mic-button:active { transform: scale(0.95); }
    #input {
      margin-top: 15px;
      padding: 12px 20px;
      font-size: 1rem;
      border: none;
      border-radius: 25px;
      width: 90%;
      max-width: 500px;
      background: #1e1e1e;
      color: white;
      outline: none;
    }
    body.light #input { background: #eee; color: black; }
    ::placeholder { color: #888; }
    .controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      padding: 10px;
    }
    select, button {
      padding: 8px 12px;
      border-radius: 6px;
      border: none;
      font-size: 1rem;
    }
  </style>
</head>
<body>
  <select id="themeToggle" onchange="changeTheme(this.value)">
    <option value="dark">üåô Dark</option>
    <option value="light">‚òÄÔ∏è Light</option>
    <option value="blue">üåä Blue</option>
    <option value="pink">üå∏ Pink</option>
    <option value="cyber">‚ö° Cyber</option>
  </select>

  <div id="chat"></div>

  <div class="controls">
    <button onclick="sendPredefined('weather')" title="Weather">‚õÖ</button>
    <button onclick="sendPredefined('joke')" title="Joke">üòÇ</button>
    <button onclick="openWebsite()" title="Visit Site">üåê</button>
    <button onclick="stopSpeaking()" title="Stop Speaking">üõë</button>
    <button onclick="clearChat()" title="Clear Chat">üßπ Clear</button>
    <button onclick="exportChat()" title="Download Chat">‚¨áÔ∏è Export</button>
    <select id="voiceSelect"></select>
  </div>

  <div id="inputArea">
    <button class="mic-button" onclick="startListening()">üé§</button>
    <input type="text" id="input" placeholder="Tap mic or type..." onkeydown="if(event.key==='Enter') sendMessage()" />
  </div>

<script>
const chat = document.getElementById("chat");
const input = document.getElementById("input");
const apiKey = "AIzaSyDTl7ffNufPlG8w9AGbdQl02H4HmCs5h-A";
const voiceSelect = document.getElementById("voiceSelect");
let voices = [];

function populateVoiceList() {
  voices = speechSynthesis.getVoices();
  voiceSelect.innerHTML = voices.map((v, i) => `<option value="${i}">${v.name} (${v.lang})</option>`).join("");
}
speechSynthesis.onvoiceschanged = populateVoiceList;
populateVoiceList();

function changeTheme(theme) {
  document.body.className = theme === 'dark' ? '' : theme;
  localStorage.setItem("theme", theme);
}
const savedTheme = localStorage.getItem("theme") || "dark";
changeTheme(savedTheme);
document.getElementById("themeToggle").value = savedTheme;

function appendMessage(text, sender, save = true) {
  const msg = document.createElement("div");
  msg.className = "message " + sender;
  const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  msg.innerHTML = `<small>${time}</small>${formatText(text)}`;
  chat.appendChild(msg);
  chat.scrollTop = chat.scrollHeight;
  if (save) saveMessage(text, sender);
  return msg;
}

function formatText(text) {
  return text
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/\*\*(.*?)\*\*/g, "<b>$1</b>")
    .replace(/\*(.*?)\*/g, "<i>$1</i>")
    .replace(/\n/g, "<br>");
}

function speak(text) {
  const utter = new SpeechSynthesisUtterance(text);
  utter.voice = voices[voiceSelect.value] || voices[0];
  utter.lang = 'en-US';
  speechSynthesis.speak(utter);
}
function stopSpeaking() { speechSynthesis.cancel(); }

function sendMessage() {
  const msg = input.value.trim();
  if (!msg) return;
  if (!navigator.onLine) {
    appendMessage("You are offline. Please check your connection.", "bot");
    return;
  }
  appendMessage(msg, "user");
  input.value = "";
  const stopLoading = appendLoading();
  sendToGemini(msg, stopLoading);
}

function sendToGemini(prompt, stopLoading) {
  fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: prompt }] }], generation_config: { maxOutputTokens: 300, temperature: 0.7 } })
  })
  .then(res => res.json())
  .then(data => {
    stopLoading();
    let reply = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || "Sorry, didn‚Äôt get that.";
    appendMessage(reply, "bot");
    speak(reply);
  })
  .catch(err => {
    stopLoading();
    appendMessage("Error fetching response.", "bot");
    console.error(err);
  });
}

function startListening() {
  if (!('webkitSpeechRecognition' in window)) return alert("Speech recognition not supported.");
  const recognition = new webkitSpeechRecognition();
  recognition.lang = 'en-US';
  recognition.start();
  recognition.onresult = e => {
    input.value = e.results[0][0].transcript;
    sendMessage();
  };
  recognition.onerror = () => alert("Could not hear you.");
}

function appendLoading() {
  const loading = document.createElement("div");
  loading.className = "message bot loading";
  loading.textContent = "Thinking";
  chat.appendChild(loading);
  let dots = 0;
  const interval = setInterval(() => {
    dots = (dots + 1) % 4;
    loading.textContent = "Thinking" + ".".repeat(dots);
  }, 500);
  return () => { clearInterval(interval); chat.removeChild(loading); };
}

function sendPredefined(type) {
  if (type === 'weather') {
    if (!navigator.geolocation) return appendMessage("Geolocation not supported.", "bot");
    navigator.geolocation.getCurrentPosition(async pos => {
      const message = await fetchWeather(pos.coords.latitude, pos.coords.longitude);
      appendMessage("What's the weather today?", "user");
      appendMessage(message, "bot");
      speak(message);
    }, () => appendMessage("Unable to get your location.", "bot"));
  } else if (type === 'joke') {
    input.value = "Tell me a joke.";
    sendMessage();
  }
}
function openWebsite() {
  const url = prompt("Enter website URL (https://...):", "https://ripplestudio.in");
  if (url) window.open(url, '_blank');
}
async function fetchWeather(lat, lon) {
  try {
    const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=46bb2e0a68c219113b00a5ce46ce947b&units=metric`);
    const data = await res.json();
    return data.main ? `The weather in ${data.name} is ${data.weather[0].description} with ${data.main.temp}¬∞C.` : "Sorry, I couldn't get the weather.";
  } catch { return "Weather service is currently unavailable."; }
}
function saveMessage(text, sender) {
  let history = JSON.parse(localStorage.getItem("chatHistory") || "[]");
  history.push({ text, sender });
  localStorage.setItem("chatHistory", JSON.stringify(history));
}
function loadHistory() {
  JSON.parse(localStorage.getItem("chatHistory") || "[]").forEach(msg => appendMessage(msg.text, msg.sender, false));
}
function clearChat() {
  localStorage.removeItem("chatHistory");
  chat.innerHTML = "";
}
function exportChat() {
  let history = JSON.parse(localStorage.getItem("chatHistory") || "[]");
  let text = history.map(m => `${m.sender.toUpperCase()}: ${m.text.replace(/<br>/g, '\n')}`).join("\n\n");
  const blob = new Blob([text], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "Ripple_Chat_History.txt";
  a.click();
  URL.revokeObjectURL(url);
}
window.onload = loadHistory;
</script>
</body>
</html>
